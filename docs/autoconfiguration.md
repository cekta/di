# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–ò–Ω–æ–≥–¥–∞ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ—á–∏—Å–ª—è—Ç—å –≤—Å–µ containers –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ—É–¥–æ–±–Ω–æ. –ì–æ—Ä–∞–∑–¥–æ –ø—Ä–æ—â–µ, –∫–æ–≥–¥–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º –Ω–∞—Ö–æ–¥–∏—Ç —Ç–æ—á–∫–∏
–≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

## üéØ –ö–æ–≥–¥–∞ —ç—Ç–æ –Ω—É–∂–Ω–æ?

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–µ–∑–Ω–∞, –∫–æ–≥–¥–∞:

* **–ú–Ω–æ–≥–æ –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, –∫–æ–º–∞–Ω–¥—ã, middleware
* **–ß–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞** - –Ω–µ –Ω—É–∂–Ω–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
* **–•–æ—á–µ—Ç—Å—è –º–µ–Ω—å—à–µ —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã** - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

–¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –æ–±—ã—á–Ω–æ –∏–º–µ—é—Ç –æ—Ç–ª–∏—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:

| –¢–∏–ø                | 	–ü—Ä–∏–∑–Ω–∞–∫                                                                                                                         |
|--------------------|----------------------------------------------------------------------------------------------------------------------------------|
| HTTP-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏   | 	–†–µ–∞–ª–∏–∑—É—é—Ç [RequestHandlerInterface](https://github.com/php-fig/http-server-handler/blob/master/src/RequestHandlerInterface.php) |
| Middleware         | 	–†–µ–∞–ª–∏–∑—É—é—Ç [MiddlewareInterface](https://github.com/php-fig/http-server-middleware/blob/master/src/MiddlewareInterface.php)      |
| –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã | 	–ù–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç [Command (Symfony)](https://github.com/symfony/console/blob/7.3/Command/Command.php)                             |
| –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏     | 	–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏–ª–∏ –∞—Ç—Ä–∏–±—É—Ç—ã                                                                                             |

**–í–∞–∂–Ω–æ:** –ù–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç `cekta/di` –Ω–µ –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ–µ–∫—Ç–∞.   
–≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–æ—Ç–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.   
–í—ã –º–æ–∂–µ—Ç–µ –ª–µ–≥–∫–æ —Å–æ–∑–¥–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–∞–∫–µ—Ç.

## üöÄ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä

[–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ GitHub](https://github.com/cekta/di-example-usage/commit/0a8bd1c45e522571fe5347943e658b39fa257355)

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫–∞

–í–∫–ª—é—á–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫–∞ –≤ composer.json:

```json
{
  "config": {
    "optimize-autoloader": true
  }
}
```

–û–±–Ω–æ–≤–∏—Ç–µ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫:

```
composer dumpautoload
```

–¢–µ–ø–µ—Ä—å –≤ —Ñ–∞–π–ª–µ `/vendor/composer/autoload_classmap.php` —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –∫–ª–∞—Å—Å–æ–≤ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.

### –®–∞–≥ 2: –°–æ–∑–¥–∞—ë–º —Å–∫–∞–Ω–µ—Ä –∫–ª–∞—Å—Å–æ–≤

/src/ProjectDiscovery.php:

```php
<?php
declare(strict_types=1);

namespace App;

use ReflectionClass;
use Throwable;

class ProjectDiscovery
{
    private array $implements = [];
    private array $containers = [];

    public function __construct(
        private readonly iterable $classes,
    ) {}

    public function containerImplement(string $interface, array $exclude = []): self
    {
        $this->implements[$interface] = $exclude;
        return $this;
    }

    public function loadContainers(): array
    {
        foreach ($this->classes as $className) {
            try {
                $class = new ReflectionClass($className);
            } catch (Throwable) {
                continue;
            }
            $this->checkImplement($class);
        }
        return array_unique($this->containers);
    }

    private function checkImplement(ReflectionClass $class): void
    {
        foreach ($this->implements as $interface => $excludes) {
            if ($class->implementsInterface($interface) && !in_array($class->getName(), $excludes)) {
                $this->containers[] = $class->getName();
            }
        }
    }
}
```

### –®–∞–≥ 3: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–∞–Ω–µ—Ä –≤ —Å–±–æ—Ä–∫–µ

/bin/build.php:

```php
<?php
declare(strict_types=1);

namespace App;

use Cekta\DI\Configuration;

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å-–º–∞—Ä–∫–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
interface MarkerForContainer {}

// –ö–ª–∞—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏–º –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
class A implements MarkerForContainer {}
class B implements MarkerForContainer {}

// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã –ø—Ä–æ–µ–∫—Ç–∞
$classMap = require __DIR__ . '/../vendor/composer/autoload_classmap.php';
$classes = array_keys($classMap);

// –°–∫–∞–Ω–∏—Ä—É–µ–º –∏ –Ω–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–µ –∫–ª–∞—Å—Å—ã
$discover = new ProjectDiscovery($classes);
$discover->containerImplement(MarkerForContainer::class);
$containers = $discover->loadContainers();

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
$code = (new Configuration(
    containers: $containers,
    fqcn: 'App\\Runtime\\Container',
))->compile();

file_put_contents(__DIR__ . '/../runtime/Container.php', $code);
```

### –®–∞–≥ 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

app.php:

```php
<?php
declare(strict_types=1);

namespace App;

$container = new \App\Runtime\Container([]);

// –í—Å–µ –∫–ª–∞—Å—Å—ã, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–µ MarkerForContainer, —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã
$a = $container->get(A::class);
$b = $container->get(B::class);
```

## ‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞

–î–æ–±–∞–≤—å—Ç–µ –≤ `composer.json`:

```json
{
  "scripts": {
    "post-autoload-dump": [
      "php ./bin/build.php"
    ]
  }
}
```

–¢–µ–ø–µ—Ä—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø—Ä–æ–≤–µ—Ä–∏–º:

/src/C.php - –°–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å
```php
<?php
declare(strict_types=1);

namespace App;

class C implements MarkerForContainer {}
```

–û–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ –∏ Container.php

```
composer dumpautoload  # –ò–ª–∏ composer install/update
```

app.php:
```php
<?php
declare(strict_types=1);

namespace App;

$container = new \App\Runtime\Container([]);

// –í—Å–µ –∫–ª–∞—Å—Å—ã, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–µ MarkerForContainer, —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã
$a = $container->get(A::class);
$b = $container->get(B::class);
$c = $container->get(C::class); // —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –Ω–∞—à –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å
```

## üí° –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã-–º–∞—Ä–∫–µ—Ä—ã** - —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
2. **–ò—Å–∫–ª—é—á–∞–π—Ç–µ –Ω–µ–Ω—É–∂–Ω—ã–µ –∫–ª–∞—Å—Å—ã** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä $exclude –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –∏–ª–∏ —Ç–µ—Å—Ç–æ–≤
3. **–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π—Ç–µ autowiring** - –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫!

---

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ø—Ä–æ—â–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –ù–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö
—É—Å–∏–ª–∏–π, –Ω–æ –∑–∞—Ç–µ–º –æ–Ω–∞ —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è –∏ —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—à–∏–±–æ–∫ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.